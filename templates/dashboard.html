<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Wellness Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Personalized Welcome Header -->
        <div class="welcome-header">
            <h1>Welcome back, {{ user.name|title }}! 🌟</h1>
            {% if user.profile_data.get('goal') %}
                <p class="daily-motivation">
                    <strong>Your {{ user.profile_data.get('goal').replace('_', ' ').title() }} Journey:</strong> 
                    {% if user.profile_data.get('goal') == 'weight_loss' %}
                        {{ contextual_message }} Every healthy choice is an investment in your future self.
                    {% elif user.profile_data.get('goal') == 'muscle_gain' %}
                        {{ contextual_message }} Strong bodies are built one day at a time.
                    {% elif user.profile_data.get('goal') == 'endurance' %}
                        {{ contextual_message }} Your stamina grows with every session.
                    {% elif user.profile_data.get('goal') == 'strength' %}
                        {{ contextual_message }} Progressive improvement builds lasting strength.
                    {% else %}
                        {{ contextual_message }} Consistency creates transformation.
                    {% endif %}
                </p>
            {% else %}
                <p class="daily-motivation">{{ contextual_message }}</p>
            {% endif %}
        </div>

        <!-- Primary Action Section - Start Your Journey -->
        <div class="primary-actions-section">
            <h2>🚀 Start Your Day</h2>
            <div class="primary-action-grid">
                <a href="/daily-log?email={{ user.email }}" class="primary-action-card">
                    <div class="action-icon">📝</div>
                    <div class="action-content">
                        <h3>Log Your Day</h3>
                        <p>Track your progress - takes just 2 minutes</p>
                        <div class="action-cta">Start Logging →</div>
                    </div>
                </a>

                {% if total_logs >= 7 %}
                <a href="/weekly-checkin?email={{ user.email }}" class="primary-action-card">
                    <div class="action-icon">📊</div>
                    <div class="action-content">
                        <h3>Weekly Review</h3>
                        <p>Reflect on your progress and plan ahead</p>
                        <div class="action-cta">Review Week →</div>
                    </div>
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Progress Stats Row -->
        <div class="progress-stats">
            <div class="stat-card">
                <div class="stat-icon">🔥</div>
                <div class="stat-number">{{ streak_days }}</div>
                <div class="stat-label">Day Streak</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📋</div>
                <div class="stat-number">{{ total_logs }}</div>
                <div class="stat-label">Total Logs</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📅</div>
                <div class="stat-number">{{ days_since_signup + 1 }}</div>
                <div class="stat-label">Days Active</div>
            </div>
        </div>

        <!-- Daily Score with Context and Insights -->
        <div class="score-insights-section">
            <h2>📊 Your Daily Score Explained</h2>
            <div class="score-card-detailed">
                {% if recent_score %}
                    <div class="score-main">
                        <div class="score-number">{{ "%.1f"|format(recent_score) }}/10</div>
                        <div class="score-status">
                            {% if recent_score >= 8 %}
                                Excellent progress! 🌟
                            {% elif recent_score >= 6 %}
                                Good momentum! 👍
                            {% elif recent_score >= 4 %}
                                Building habits! 💪
                            {% else %}
                                Every step counts! 🌱
                            {% endif %}
                        </div>
                    </div>

                    <div class="score-breakdown">
                        <h4>How Your Score Works:</h4>
                        <div class="score-factors">
                            {% if user.profile_data.get('goal') == 'weight_loss' %}
                                <div class="factor">
                                    <span class="factor-icon">🥗</span>
                                    <span class="factor-text"><strong>Nutrition (40%):</strong> Whole foods and portion control are prioritised for weight loss</span>
                                </div>
                                <div class="factor">
                                    <span class="factor-icon">🏃‍♀️</span>
                                    <span class="factor-text"><strong>Activity (30%):</strong> Cardio and movement help create the calorie deficit you need</span>
                                </div>
                                <div class="factor">
                                    <span class="factor-icon">😴</span>
                                    <span class="factor-text"><strong>Sleep (20%):</strong> 7-9 hours regulates hunger hormones crucial for weight loss</span>
                                </div>
                                <div class="factor">
                                    <span class="factor-icon">💧</span>
                                    <span class="factor-text"><strong>Hydration (10%):</strong> Supports metabolism and helps control appetite</span>
                                </div>
                            {% elif user.profile_data.get('goal') == 'muscle_gain' %}
                                <div class="factor">
                                    <span class="factor-icon">🏋️‍♀️</span>
                                    <span class="factor-text"><strong>Strength Training (40%):</strong> Progressive overload builds muscle</span>
                                </div>
                                <div class="factor">
                                    <span class="factor-icon">🥩</span>
                                    <span class="factor-text"><strong>Protein Intake (30%):</strong> Essential for muscle repair and growth</span>
                                </div>
                                <div class="factor">
                                    <span class="factor-icon">😴</span>
                                    <span class="factor-text"><strong>Recovery (25%):</strong> Muscles grow during rest, not during workouts</span>
                                </div>
                                <div class="factor">
                                    <span class="factor-icon">💧</span>
                                    <span class="factor-text"><strong>Hydration (5%):</strong> Supports muscle function and recovery</span>
                                </div>
                            {% else %}
                                <div class="factor">
                                    <span class="factor-icon">😊</span>
                                    <span class="factor-text"><strong>Mood & Energy (25%):</strong> Positive mindset supports all health goals</span>
                                </div>
                                <div class="factor">
                                    <span class="factor-icon">🏃‍♀️</span>
                                    <span class="factor-text"><strong>Movement (25%):</strong> Any activity counts towards better health</span>
                                </div>
                                <div class="factor">
                                    <span class="factor-icon">😴</span>
                                    <span class="factor-text"><strong>Sleep Quality (25%):</strong> Foundation of good health and energy</span>
                                </div>
                                <div class="factor">
                                    <span class="factor-icon">🥗</span>
                                    <span class="factor-text"><strong>Nutrition (25%):</strong> Balanced eating supports overall wellbeing</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Personalised Insights from Latest Log -->
                    {% if daily_logs and daily_logs[-1].get('personalised_insights') %}
                        <div class="insights-section">
                            <h4>💡 Your Personalised Insights:</h4>
                            {% for insight in daily_logs[-1]['personalised_insights'][:3] %}
                                <div class="insight-item">{{ insight }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Goal-Specific Today's Focus -->
                    <div class="todays-focus">
                        <h4>🎯 Today's Focus:</h4>
                        {% if user.profile_data.get('goal') == 'weight_loss' %}
                            <p>Focus on creating a sustainable calorie deficit through nutritious foods and movement. Remember, 1-2 pounds per week is healthy and sustainable weight loss.</p>
                        {% elif user.profile_data.get('goal') == 'muscle_gain' %}
                            <p>Prioritise protein at each meal and progressive overload in your workouts. Muscle building takes time - consistency over months creates visible results.</p>
                        {% elif user.profile_data.get('goal') == 'endurance' %}
                            <p>Build your cardiovascular fitness gradually. Mix steady-state cardio with interval training for the best endurance gains.</p>
                        {% elif user.profile_data.get('goal') == 'strength' %}
                            <p>Focus on compound movements and gradually increasing weights. Strength gains come from progressive overload and proper recovery.</p>
                        {% else %}
                            <p>Balance all aspects of health - movement, nutrition, sleep, and mental wellbeing. Small consistent improvements create lasting change.</p>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="score-placeholder">
                        <div class="score-number">?/10</div>
                        <div class="score-status">Ready to start! 🌟</div>
                        <p>Complete your first daily log to get your personalised score and insights tailored to your {{ user.profile_data.get('goal', 'fitness').replace('_', ' ') }} goals.</p>
                        <a href="/daily-log?email={{ user.email }}" class="start-logging-btn">Start Logging Today</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Your Personal Coaching Section -->
        <div class="coaching-section">
            <h2>🏃‍♀️ Your Personal Coach</h2>
            <div class="coaching-cards">
                {% if user.profile_data.get('goal') == 'weight_loss' %}
                    <div class="coaching-card">
                        <div class="coaching-icon">🍽️</div>
                        <h4>Today's Nutrition Tip</h4>
                        <p>Try eating protein with every meal to stay fuller for longer and support your metabolism. Aim for lean sources like chicken, fish, eggs, or legumes.</p>
                    </div>
                {% elif user.profile_data.get('goal') == 'muscle_gain' %}
                    <div class="coaching-card">
                        <div class="coaching-icon">💪</div>
                        <h4>Today's Training Tip</h4>
                        <p>Focus on progressive overload - gradually increase weight, reps, or sets each week. Your muscles adapt to challenges, so keep progressing!</p>
                    </div>
                {% else %}
                    <div class="coaching-card">
                        <div class="coaching-icon">⚡</div>
                        <h4>Today's Wellness Tip</h4>
                        <p>Movement doesn't have to be intense to be beneficial. A 10-minute walk, some stretching, or dancing to your favourite songs all count!</p>
                    </div>
                {% endif %}

                {% if user.profile_data.get('health_conditions') and 'stress' in user.profile_data.get('health_conditions', '').lower() %}
                    <div class="coaching-card">
                        <div class="coaching-icon">🧘‍♀️</div>
                        <h4>Stress Management</h4>
                        <p>Since you mentioned stress, try 5 minutes of deep breathing today. Inhale for 4 counts, hold for 4, exhale for 6. This activates your calm response.</p>
                    </div>
                {% elif user.profile_data.get('activity_level') == 'sedentary' %}
                    <div class="coaching-card">
                        <div class="coaching-icon">🚶‍♀️</div>
                        <h4>Movement Reminder</h4>
                        <p>Start small! Set a timer to stand and stretch every hour. Even 2-minute movement breaks can boost energy and improve your day.</p>
                    </div>
                {% else %}
                    <div class="coaching-card">
                        <div class="coaching-icon">💧</div>
                        <h4>Hydration Check</h4>
                        <p>Aim for clear or pale yellow urine as a hydration guide. Start your day with a glass of water and keep a bottle nearby as a reminder.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Device Tracking Section - Remember User Choice -->
        <div class="tracking-section">
            <h2>📱 Your Tracking Setup</h2>
            {% set fitness_tokens = user.get('fitness_tokens', {}) %}
            {% set connected_devices = [] %}
            {% if fitness_tokens.get('fitbit_access_token') %}{% set _ = connected_devices.append('Fitbit') %}{% endif %}
            {% if fitness_tokens.get('oura_access_token') %}{% set _ = connected_devices.append('Oura Ring') %}{% endif %}
            {% if fitness_tokens.get('google_fit_access_token') %}{% set _ = connected_devices.append('Google Fit') %}{% endif %}

            {% if user.profile_data.get('preferred_device') %}
                <div class="device-selected">
                    <div class="device-status">
                        <span class="device-name">{{ user.profile_data.get('preferred_device').replace('_', ' ').title() }}</span>
                        {% if user.profile_data.get('preferred_device') in ['fitbit', 'oura', 'google_fit'] and connected_devices %}
                            <span class="status-badge connected">✅ Connected</span>
                        {% else %}
                            <span class="status-badge manual">📝 Manual Entry</span>
                        {% endif %}
                    </div>
                    <p class="tracking-philosophy">Remember: Your device tracks numbers, but only you can track how you feel. This combination of data gives the complete picture of your health journey.</p>

                    {% if user.profile_data.get('preferred_device') == 'manual' or user.profile_data.get('preferred_device') not in connected_devices %}
                        <div class="manual-encouragement">
                            <p>✨ <strong>Manual tracking builds powerful habits!</strong> You're developing mindful awareness of your body and choices - this self-knowledge is incredibly valuable for long-term success.</p>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <div class="device-selection">
                    <p>Choose how you'd like to track your fitness data:</p>
                    <a href="/connect-devices?email={{ user.email }}" class="connect-devices-btn">Set Up Tracking</a>
                </div>
            {% endif %}
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions-grid">
            <a href="/ai-chat?email={{ user.email }}" class="action-card ai-card">
                <div class="card-icon">🤖</div>
                <h3>Ask Your AI Coach</h3>
                <p>Get personalised advice and support</p>
            </a>

            <a href="/connect-devices?email={{ user.email }}" class="action-card devices-card">
                <div class="card-icon">📱</div>
                <h3>Device Settings</h3>
                <p>Connect or change your fitness tracker</p>
            </a>

            <a href="/questionnaire?email={{ user.email }}" class="action-card profile-card">
                <div class="card-icon">⚙️</div>
                <h3>Update Profile</h3>
                <p>Modify your goals and preferences</p>
            </a>

            {% if user.subscription_tier == 'free' %}
            <a href="/subscription?email={{ user.email }}" class="action-card premium-card">
                <div class="card-icon">✨</div>
                <h3>Upgrade to Premium</h3>
                <p>Unlock unlimited AI insights</p>
            </a>
            {% endif %}
        </div>

        <!-- Subscription Status -->
        {% if user.subscription_tier == 'free' %}
        <div class="subscription-prompt">
            <div class="prompt-content">
                <h3>🚀 Ready for More Personalised Support?</h3>
                <p>Upgrade to Premium for unlimited AI coaching, meal planning, and advanced insights tailored to your goals.</p>
                <a href="/subscription?email={{ user.email }}" class="upgrade-button">Upgrade to Premium - £9.97/month</a>
            </div>
        </div>
        {% endif %}
    </div>
</body>
</html>